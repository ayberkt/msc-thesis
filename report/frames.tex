\chapter{Frames}\label{chap:frames}

We present in this chapter the lattice-theoretic notion of a \emph{frame}. In
Chapter~\ref{chap:intro}, we remarked that a frame is the algebra of a logic of finitely
verifiable properties. Recall that a frame consists of the following:
\begin{itemize}
  \item a set $O$ of \emph{opens},
  \item a partial order $\_\sqsubseteq\_ \subseteq O \times O$, corresponding to the set inclusion order of the
    open subsets,
  \item finite meets, and
  \item arbitrary joins.
\end{itemize}

In addition to these, we need a law to ensure the correct interplay between meets and
joins. Suppose we have a set $A$ and a family of sets $B_0, B_1, \cdots$. Consider the set:
\begin{equation*}
  A \cap (\bigcup_i B_i).
\end{equation*}
By set-theoretic reasoning, this is the same as:
\begin{equation*}
  \bigcup_i (A \cap B_i).
\end{equation*}
As we are trying to characterise the behaviour of open sets, without defining them as sets
of points, we have to explicitly add this distributivity law into the definition of a
frame. Put simply:
\begin{center}
  \emph{binary meets must distribute over arbitrary joins in a frame.}
\end{center}

We now start presenting our formal development of frames. We start with partially ordered
sets in Section~\ref{sec:poset}. In Section~\ref{sec:frame}, we present the definition of
a frame. In Section~\ref{sec:frame-univ}, we discuss our proof that isomorphic frames are
equal, which can be considered the hallmark of the fact that our development takes place
in a univalent context. In sections \ref{sec:down-set-frame} and \ref{sec:nuclei}, we
prove two important lemmas in preparation for the chapter on formal topology
(Chapter~\ref{chap:formal-topo}): (1) the set of downwards-closed subsets of a poset forms
a frame and (2) given a nucleus (a technical notion to be introduced) on a frame, its set
of fixed points is itself a frame.

\section{Partially ordered sets}\label{sec:poset}

This section corresponds to the \modname{Poset} module in the \veragda{} development.

\begin{defn}[Poset]\label{defn:poset}
  Given some $\oftyI{A}{\univ{}_m}$, let $\order{n}{A} \is A \rightarrow A \rightarrow \hprop{}_n$. A poset
  with carrier level $m$ and relation level $n$ is then defined as:
  \begin{equation*}
    \poset{}_{m, n} \quad\is\quad \sigmaty{A}{\univ_m}{\posetstr{n}{A}},
  \end{equation*}
  \begin{center}
  where
  \end{center}
  \begin{align*}
    \posetstr{n}{A} \quad&\is\quad \sigmaty{R}{\order{n}{A}}{\posetax{A, R}}              \\
    \posetaxnm \quad&:\quad \left(\sigmaty{A}{\univ{}_m}{\order{n}{A}}\right) \rightarrow \hprop{}  \\
    \posetax{A, R} \quad&\is\quad ~~\pity{x}{A}{R(x, x)}                      \\
                    &\hspace{0.3em}\times \pity{x~y~z}{A}{R(x, y) \rightarrow R(y, z) \rightarrow R(x, z)} \\
                    &\hspace{0.3em}\times \hspace{0.3em}\pity{x~y}{A}{R(x, y) \rightarrow R(y, x) \rightarrow x =_A y}   \\
                    &\hspace{0.3em}\times \isset{A}.
  \end{align*}
  The function name $\posetstrnm{}$ is intended to be an abbreviation of ``poset
  structure'', that is, an ordered structure subject to the axioms for a partial order.
  The predicate expressing that a given ordered structure satisfies these axioms is in
  turn abbreviated by the function name $\posetaxnm{}$. Propositionality of $\posetaxnm{}$
  follows by propositions \ref{prop:sigma-prop}, \ref{prop:pi-prop}, and
  \ref{prop:set-prop}.
\end{defn}

Given a poset $P$, we will refer to its relation as $\_\sqsubseteq_P\_$ (in cases where there might
be ambiguity) and the underlying set of $P$ as $\abs{P}$. Notice that the fourth component
of $\posetaxnm{}$ requires the carrier set to be an h-set (Defn.~\ref{defn:hset}).

We can talk about the \emph{downwards-closed subsets} of a given poset $P$: sets that
include all elements below their elements. One way of reading this is as expressing the
property of being closed under refinement or ``collection of more information''. Take a
certain element $x : \abs{P}$ that we view as a stage of information. For some other
$\oftyI{y}{\abs{P}}$, $y \sqsubseteq x$ expresses the idea that $y$ is a \emph{finer} stage of
information: it approximates the result better meaning it confines it into a
\emph{narrower} range. Let $U$ be a subset of $\abs{P}$. The property that $U$ is
downwards-closed is then nothing but:
\begin{equation*}
  \mempow{x}{U} \rightarrow y \sqsubseteq x \rightarrow \mempow{y}{U},
\end{equation*}
the intuitive reading of which is: $U$ is closed under the reception of more information.
In other words, regardless of how things unfold after $x$ has been reached, the stage of
information we end up at will still be in $U$. One can therefore say that $U$ is itself
like an observable property on $\abs{P}$: given a sequence $x_0 \sqsupseteq x_1 \sqsupseteq \cdots$ of stages of
information that eventually ``hits'' $U$, no further examination will be needed as soon as
we find the first element that hits $U$.

Let us now formally summarise the notion of downwards-closure.
\begin{defn}[Downwards-closed subset]\label{defn:dc-subset}
  We first define a predicate expressing that a given subset $\oftyI{U}{\pow{\abs{P}}}$ of
  some poset $P$ is downwards-closed:
  \begin{alignat*}{2}
    \isdcnm{}   &\quad:\quad     &&\left(\sigmaty{P}{\poset{}}{\pow{\abs{P}}}\right) \rightarrow \hprop{}                        \\
    \isdc{P, U} &\quad\is{}\quad &&\pity{x~y}{\abs{P}}{\mempow{x}{U} \rightarrow y \sqsubseteq x \rightarrow \mempow{y}{U}} .
  \end{alignat*}
  The propositionality follows by Prop.~\ref{prop:pi-prop}. We then define the
  type of downwards-closed subsets of a poset as:
  \begin{alignat*}{2}
    \dcsubsetnm{} &\quad:\quad     &&\poset{} \rightarrow \univ{}                      \\
    \dcsubset{P}  &\quad\is{}\quad &&\sigmaty{U}{\pow{\abs{P}}}{\isdc{P, U}} .
  \end{alignat*}
\end{defn}

So far we have dealt with two notions of \emph{observable property} throughout the
development:
\begin{enumerate}
  \item elements of a poset which we will view as opens when we get to frames, and
  \item the notion of downwards-closed subset which expresses that a property of the poset
    of opens behaves like an observable property.
\end{enumerate}
We will now start relating these two by showing that the set of downwards-closed subsets
of a poset is itself a poset, and indeed, we will prove later (in
Sec.~\ref{sec:down-set-frame}) that it actually forms a frame meaning downwards-closed
subsets satisfy our expectations from properties we view as observable.

Let us start by showing that $\dcsubset{P}$ is always a set.
\begin{prop}\label{prop:dcsubset-set}
  $\dcsubset{P}$ is a set for every poset $P$.
\end{prop}
\begin{proof}
  By Proposition~\ref{prop:sigma-set}, it suffices to show that $\pow{\abs{P}}$ is a set
  and $$\isdc{P, U}$$ is a set for every $\oftyI{U}{\pow{\abs{P}}}$. The former holds by
  Proposition~\ref{prop:pow-set}. For the latter, observe that every $\isdc{P, U}$ is a
  proposition by definition meaning it is also a set by
  Proposition~\ref{prop:prop-is-set}.
\end{proof}

We can now proceed to construct the poset of downwards-closed subsets.
\begin{prop}(Poset of downwards-closed subsets)\label{prop:dc-poset}
  Let $P$ be a poset. The type $\dcsubset{P}$ forms a poset under the
  subset inclusion relation (Defn.~\ref{defn:inclusion}).
\end{prop}
\begin{proof}
  The fact that $\dcsubset{P}$ is a set is given by Proposition~\ref{prop:dcsubset-set} so
  it suffices to show that the poset axioms are satisfied. Reflexivity and transitivity
  are immediate. For antisymmetry, let $\oftyII{(U, \_)}{(V, \_)}{\dcsubset{P}}$ and
  assume $\subsetof{U}{V}$, $\subsetof{V}{U}$. By Proposition~\ref{prop:to-subtype}, it
  suffices to show $U = V$ as downwards-closure is a proposition. By function
  extensionality (Prop.~\ref{prop:funext}), it remains to be shown that for every
  $\oftyI{x}{\abs{P}}$, $U(x) = V(x)$. Let $\oftyI{x}{\abs{P}}$. By univalence
  (Axiom~\ref{ax:ua}), we are done if can show $\typequiv{U(x)}{V(x)}$ which must clearly
  be the case by Prop.~\ref{prop:iff-equiv} as we know $\logequiv{U(x)}{V(x)}$.
\end{proof}

Observe that we have made use univalence and function extensionality here. If we were
working in a non-univalent setting, we would already have to resort to postulates or start
using setoids at this point.

\subsection{Monotonic functions}

Let us now write down the type of those functions that preserve the partial order
structure of a poset: monotonic maps.

\begin{defn}[Monotonic function]\label{defn:mono-map}
  Let $P, Q$ be posets. A function $f : \abs{P} \rightarrow \abs{Q}$ is monotonic if the following
  type is inhabited:
  \begin{equation*}
    \ismonotonic{f} \quad\is\quad \pity{x~y}{\abs{P}}{x \sqsubseteq_P y \rightarrow f(x) \sqsubseteq_Q f(y)}.
  \end{equation*}
  We collect the type of monotonic functions between posets $P$ and $Q$ in the following
  type:
  \begin{equation*}
    \mono{P}{Q} \quad\is\quad \sigmaty{f}{\abs{P} \rightarrow \abs{Q}}{\ismonotonic{f}}.
  \end{equation*}
\end{defn}

\begin{defn}[Poset isomorphism]\label{defn:poset-iso}
  An isomorphism between two posets is a monotonic function with a monotonic inverse.
  We will denote the type of isomorphisms between two posets $P$ and $Q$ by
  $\posetiso{P}{Q}$.
\end{defn}

\section{Definition of a frame}\label{sec:frame}

We now proceed to define frames as discussed. The constructions presented here can be
found in the \modname{Frame} module in the \veragda{} formalisation.

\begin{defn}[Frame]\label{defn:frame}
  A frame structure on some type $A$ consists of the following data: (1) a poset
  structure, (2) a top element, (3) a binary meet operation, and (4) a join operation of
  arbitrary arity, which we define using families. We then define a raw frame structure
  with relation level $n$ and index level $o$ as:
  \begin{equation*}
    \rawframestr{n}{o}{A} \quad\is\quad \posetstr{n}{A} \times A \times (A \rightarrow A \rightarrow A) \times (\sub{o}{A} \rightarrow A).
  \end{equation*}
  The prefix ``raw'' is used to signify that it is the \emph{structural} component of the
  definition: it is merely some data that may or may not satisfy the laws imposed upon it.
  Such a raw structure that obeys the following axioms is called a \emph{frame}.
  \begin{alignat*}{2}
    \frameax{\sqsubseteq, \top, \wedge, \bigvee} \quad&\is\quad             &&\mathsf{isTop}(\top) \times
                                              \mathsf{isGLB}(\wedge) \times
                                              \mathsf{isLUB}\left( \bigvee \right)\\
                          &\hspace{0.55em}\times &&\mathsf{isDistr}\left( \wedge, \bigvee \right)
  \end{alignat*}
  where
  \begin{alignat*}{2}
    \mathsf{isTop}(\top) \quad&\is\quad &&\pity{x}{A}{x \sqsubseteq \top}\\
    \mathsf{isGLB}(\wedge) \quad&\is\quad &&\pity{x~y}{A}{(x \wedge y \sqsubseteq x) \times (x \wedge y \sqsubseteq y)}\\
                       &\hspace{0.55em}\times &&\pity{x~y~z}{A}{(z \sqsubseteq x) \times (z \sqsubseteq y) \rightarrow z \sqsubseteq x \wedge y}\\
    \mathsf{isLUB}\left(\bigvee\right) \quad&\is\quad
         &&\pity{U}{\sub{o}{A}}{\pity{x}{A}{\memfam{x}{U} \rightarrow x \sqsubseteq \bigvee_i U_i}}\\
         &\hspace{0.55em}\times &&\pity{U}{\sub{o}{A}}{\pity{x}{A}{
        \left( \pity{y}{A}{\memfam{y}{U} \rightarrow y \sqsubseteq x}\right) \rightarrow \bigvee_i U_i \sqsubseteq x }}\\
    \mathsf{isDistr}(\wedge, \bigvee) \quad&\is\quad
      &&\pity{U}{\sub{o}{A}}{\pity{x}{A}{
          x \wedge \bigvee_i U_i} =_A \bigvee_i \left( x \wedge U_i \right)
      }
  \end{alignat*}
  A minor notational clarification: the scope of the $\prod$ types do not extend to the new
  line in the cases where the lines are separated by $\times$. We then define the type of
  frames as:
  \begin{align*}
    \framety{m}{n}{o} \quad&\is\quad \sigmaty{A}{\univ{}_m}{\framestr{A}},            \\
                       &\text{where}                                          \\
    \framestr{A}      \quad&\is\quad \sigmaty{s}{\rawframestr{n}{o}{A}}{\frameax{s}}  .
  \end{align*}
\end{defn}

We will use the notation $\abs{F}$ for referring to the underlying set of a frame, as we
do for posets. Similarly, we will refer to the underlying partial order as $\_\sqsubseteq_F\_$, the
join operator as $\bigvee^F$, and the meet operator as $\wedge_F$. We will colloquially refer to the
underlying poset of a given frame $F$ which we will denote $\posof{F}$.

Notice at this point the source of the predicativity problems: in the definition of
$\mathsf{isLUB}$, we are quantifying over \emph{subsets}. We have a type that quantifies
over other types, which in type theory, is a ``large'' type. This quickly gives rise to
problems: if we were to work with this, we would be able to have only joins of families
whose index types live in the ground universe; this would be sufficient for entertaining
only trivial examples of topologies.

Let us now note that $\frameaxnm{}$ is propositional as one would expect.
\begin{prop}\label{prop:frame-ax-prop}
  For every raw frame structure $(\sqsubseteq, \top, \wedge, \bigvee)$, $\frameax{\sqsubseteq, \top, \wedge, \bigvee}$ is a proposition.
\end{prop}
\begin{proof}[Proof sketch]
  By Proposition~\ref{prop:sigma-prop}, it suffices to show that each component is an
  h-prop. For $\mathsf{isTop}$, $\mathsf{isGLB}$, and $\mathsf{isLUB}$ this can be
  concluded by using Proposition~\ref{prop:sigma-prop} and Proposition~\ref{prop:pi-prop}.
  For $\mathsf{isDistr}$, we use Proposition~\ref{prop:pi-prop} followed by the fact that
  the underlying set of a poset is an h-set (by the definition of $\posetaxnm{}$ from
  Definition~\ref{defn:poset}).
\end{proof}

\subsection{Frame homomorphisms}

As we have just introduced a new structure, we shall define what it means for a function
to preserve this structure.

\begin{defn}[Frame homomorphism]\label{defn:frame-homo}
  Let $F$ and $G$ be frames with the same index level. A frame homomorphism from $F$ to
  $G$ is a monotonic map (Defn.~\ref{defn:mono}) from the underlying poset of $F$ to the
  underlying poset of $G$ that preserves the top element, the meets, and the joins.
  Formally,
  \begin{alignat*}{5}
    \isframehomo{f} \quad&\is\quad && &&f(\top_F) &&\idnm{} &&\top_G \\
      &\hspace{0.55em}\times\quad  &&\hspace{0.86em}\pity{x~y}{\abs{F}}{&&f(x \wedge_F y) &&\idnm{} &&f(x) \wedge_G f(y)} \\
      &\hspace{0.55em}\times\quad  &&\pity{U}{\sub{o}{\abs{F}}}{&&f(\bigvee^F U) &&\idnm{} &&\bigvee^G \setof{ f(x) ~|~ x \in U }}.
  \end{alignat*}
  Observe that this is propositional by propositions \ref{prop:sigma-prop},
  \ref{prop:pi-prop}, and the fact that the carrier of $G$ is an h-set. The type of frame
  homomorphisms between $F$ and $G$ is then just:
  \begin{equation*}
    \framehomo{F}{G} \quad\is\quad \sigmaty{f}{\mono{\posof{F}}{\posof{G}}}{\isframehomo{f}}.
  \end{equation*}
\end{defn}

\begin{defn}\label{defn:frame-iso}
  A frame isomorphism is a frame homomorphism with an inverse that is also a frame
  homomorphism.
\end{defn}

We could strengthen this definition so that it requires only the preservation of the
underlying order. This would be equivalent since all poset isomorphisms preserve meets and
joins.
\begin{defn}\label{defn:frame-iso-official}
  An isomorphism of frame $F$ and $G$ is simply an isomorphism of their underlying posets.
\end{defn}
We will consider notions of frame isomorphisms in detail in Sec.~\ref{sec:frame-univ}.

\section{Some properties of frames}

\begin{prop}[Meet commutativity]\label{prop:comm}
  In any frame $F$, $x \wedge_F y = y \wedge_F x$ for all $\oftyII{x}{y}{\abs{F}}$.
\end{prop}
\begin{proof}
  By antisymmetry, it suffices to show $x \wedge_F y \sqsubseteq_F y \wedge_F x$ and $y \wedge_F x \sqsubseteq x \wedge_F y$. This
  is direct since both of $x \wedge_F y$ and $y \wedge_F x$ are lower bounds of $x$ and $y$.
\end{proof}

We will need the following important lemma when we get to the universal property.
\begin{lemma}[Flattening lemma]\label{lem:flatten}
  Let $\oftyI{F}{\framety{m}{n}{o}}$ and let $\oftyI{f}{\pity{a}{A}{B(a) \rightarrow \abs{F}}}$ for
  some $\oftyI{A}{\univ{}_o}$ and $\oftyI{B}{A \rightarrow \univ{}_o}$. The following equality
  holds:
  \begin{equation*}
      \bigvee^F \setof{ \bigvee^F \setof{ f(a, b) ~|~ b \in B(a) } ~|~ \oftyI{a}{A}          }
    = \bigvee^F \setof{ f(a, b)             ~|~ \oftyI{(a, b)}{\sigmaty{x}{A}{B(x)}} }.
  \end{equation*}
\end{lemma}

We omit the proof of Lemma~\ref{lem:flatten} as its content is not particularly
interesting and involves a non-trivial amount of bureaucracy. It can be found in the
\veragda{} formalisation, in the \modname{Frame} module; the constructed inhabitant is
named \fnname{flatten}.

The distributivity law we required in the definition of a frame applies only in cases
where we have the join as the right-hand conjunct of a meet. Therefore we cannot
simultaneously distribute the meet of two joins to get a join of meets. Of course, this
does not matter thanks to Prop.~\ref{prop:comm}, but it is a bit inconvenient to have to
explicitly apply Prop.~\ref{prop:comm} for this purpose. Therefore we record the following
fact for simultaneously distributing the meet of two joins.

\begin{prop}\label{prop:distr}
  Let $\oftyI{F}{\framety{m}{n}{o}}$ and $\oftyII{U}{V}{\sub{o}{\abs{F}}}$. Call the index
  types of $U$ and $V$, $I$ and $J$, respectively. The following equality holds:
  \begin{equation*}
      \left( \bigvee_i U_i \right) \wedge \left( \bigvee_i V_i \right)
    = \bigvee \setof{ U_i \wedge V_j ~|~ \oftyI{(i, j)}{I \times J} }.
  \end{equation*}
\end{prop}
\begin{proof}[Proof sketch]
  Apply the distributivity law, use commutativity (Prop.~\ref{prop:comm}), apply the
  distributivity law again, and then flatten (using Lemma~\ref{lem:flatten}).
\end{proof}

\section{Univalence for frames}\label{sec:frame-univ}

It is common practice in mathematics to regard two isomorphic structures as equal.
However, this requires isomorphisms to be viewed as the appropriate notion of equality on
structures, as neither set-theoretical nor (non-univalent) type-theoretical foundations
support this informal practice. This introduces an unnecessary bifurcation of the notion
of equality and has to be remedied by ad hoc methods such as quotienting. One of the
remarkable features of univalent type theory is that it addresses this problem: in a
univalent setting, we can actually prove that two isomorphic structures are equal.

As frames are the central objects of study of this thesis, we prove that isomorphic frames
are equal. In fact, we prove that there is an equivalence between the type of isomorphisms
between two frames and the type of equality proofs between them. For this, we make use of
a \emph{structure identity principle} (SIP for short): a description of the identity type
between two structures in terms of (well-behaved) equivalences of the carrier types (as
explained by Escardó~\cite{escardo-uf-intro}). The published SIP was formulated by Coquand
and Danielsson~\cite{coq-nad} and another one (due to Peter Aczel) is given in the HoTT
Book~\cite{hottbook}.

We use the SIP due to Martín Escardó~\cite{escardo-uf-intro}, as implemented in the
\texttt{cubical} library~\cite{agda-cubical} of \veragda{}. Instead of going into the
proof details, we provide a high-level overview of what this SIP requires and what exact
results we have obtained by making use of it in the \veragda{} formalisation.

We have specified the \emph{structure} of a poset and a frame (in definitions
\ref{defn:poset} and \ref{defn:frame}) in two steps: (1) writing down a function of type
$\univ{}_m \rightarrow \univ{}_n$, expressing what it means for a type to have a certain structure,
and (2) describing the isomorphisms of such structures (by defining what it means for a
function to preserve the structure defined in (1)).

The result of Escardó~\cite{escardo-uf-intro} applies to a general notion of structure, as
specified by (1) and (2). This requires us to describe the conditions under which a notion
of isomorphism of structures is well-behaved. Such a definition of what it means for an
equivalence of carrier types to respect a given structure is called a \emph{standard
  notion of structure} by Escard\'{o}~\cite{escardo-uf-intro}.

When is an isomorphism well-behaved? Let $\oftyI{S}{\univ{}_m \rightarrow \univ{}_n}$ be a
structure, and let $\iota$ be a function expressing that a given equivalence between types $A$
and $B$, equipped with $S$-structures $s_A$ and $s_B$, preserves these structures. The
type of $\iota$ looks like the following:
\begin{equation*}
  \oftyI{\iota}{%
    \pity{(A , \_)~(B , \_)}{\sigmaty{X}{\univ{}_m}{S(X)}}{%
      \typequiv{A}{B} \rightarrow \univ{}_o
    }
  }.
\end{equation*}

In the case of posets, for instance, we pick $S \is \posetstrnm{}_k$ which has type:
\begin{equation*}
  \oftyI{\posetstrnm{}_k}{\univ{}_m \rightarrow \univ{}_{\max(m, k+1)}},
\end{equation*}
and define $\iota$ as:
\begin{equation*}
  \iota(P, Q, (f , \_)) \quad\is\quad \ismonotonic{f} \times \ismonotonic{\invequiv{f}}  .
\end{equation*}
This delineates those type equivalences between $\abs{P}$ and $\abs{Q}$ that have the
virtue of preserving their poset structures. We call this a \emph{monotonic equivalence}
and denote the type of monotonic equivalences between $\abs{P}$ and $\abs{Q}$ by
$\posetequiv{P}{Q}$.
\begin{defn}[Monotonic equivalence]\label{defn:poset-equiv}
  \begin{equation*}
    \posetequiv{P}{Q} \quad\is\quad \sigmaty{e}{\typequiv{\abs{P}}{\abs{Q}}}{\iota(P, Q, e)}
  \end{equation*}
\end{defn}

In the general case, we require $\iota$ to satisfy two conditions to make sure it is a
well-behaved characterisation of $S$-homomorphic equivalences.
\begin{enumerate}
  \item The identity equivalence meets the $\iota$ criterion: for every $$\oftyI{(A,
    s)}{\sigmaty{X}{\univ{}}{S(X)}},$$ $\iota((A, s), (A, s), \idequiv{A})$ is inhabited.
  \item Given some $\iota$ satisfying (1), and given a type $A$ with two structures
    $\oftyII{s}{t}{S(A)}$, there is a map:
    \begin{equation*}
      s = t \rightarrow \iota((A, s), (A, t), \idequiv{A}).
    \end{equation*}
    The second requirement is that this map is an equivalence for every type $A$ and for
    every two $S$-structures $s$ and $t$ on it.
\end{enumerate}

Let $\oftyI{S}{\univ{}_m \rightarrow \univ{}_n}$ be a structure and let $\oftyII{A}{B}{\univ{}_m}$
be two types equipped with $S$-structures $s$ and $t$. The SIP~\cite{escardo-uf-intro, agda-cubical}
then gives us the following result:
\begin{quote}
  if $S$ is standard in the sense that there is some $\iota$ satisfying (1) and (2) for it,
  the type of $\iota$-equivalences between $(A, s)$ and $(B, t)$ is equivalent to the identity
  type between them.
\end{quote}

We have explained already how we use the SIP for posets. Let us now explain how we use it
for frames. The situation is quite similar; frames form an SNS with $S \is
\framestrnm{}_{n, o}$ and $\iota$ expressing the notion of an equivalence being homomorphic by
requiring both directions to be frame homomorphisms as defined in
Defn.~\ref{defn:frame-homo}. We will denote such frame-homomorphic equivalences between
frames $F$ and $G$ by $\frameequiv{F}{G}$

\begin{defn}[Frame-homomorphic equivalence]\label{defn:frame-equiv}
  Let $\oftyI{e}{\typequiv{A}{B}}$ be an equivalence between types $A$ and $B$ that are
  equipped with frame structures $s_A$ and $s_B$. $e$ is called frame-homomorphic if both
  $f \is \mathsf{pr}_1(e)$ and $g \is \mathsf{pr}_1(\invequiv{e})$ are frame
  homomorphisms. We denote the type of such equivalences by
  $\frameequiv{(A, s_A)}{(B , s_B)}$.
\end{defn}

We noted in Chapter~\ref{chap:foundations} that the type of type isomorphisms is
equivalent to the type of type equivalences in the special case when the types are h-sets.
As we are working with algebraic structures that have carrier h-sets, the notions of
frame-homomorphic and monotonic equivalences are not precisely what we want; we should
instead use the familiar notion of categorical isomorphism, as we gave in definitions
\ref{defn:poset-iso} and \ref{defn:frame-iso}.

In the case of posets, we prove the equivalence of $\posetequiv{P}{Q}$ with
$\posetiso{P}{Q}$ for any two posets $P$ and $Q$. The final result then follows from this
combined with the equivalence given by the SIP:
\begin{equation*}
  \typequiv{(\posetiso{P}{Q})}{\typequiv{(\posetequiv{P}{Q})}{(P \equiv Q)}}.
\end{equation*}

In the case of frames, our notion of isomorphism does not even need to require the
preservation of frame data (as remarked in Defn.~\ref{defn:frame-iso-official}); simply
preserving the partial order suffices. It is, however, quite convenient to carry out the
SNS proof with a notion of frame homomorphism that explicitly requires the preservation of
frame data. It is for this reason that, in the \veragda{} formalisation, we first obtain
the result (using the SIP)
\begin{equation}\label{eqn:frame-equiv-1}
  \typequiv{(\frameequiv{F}{G})}{(F \equiv G)},
\end{equation}
and after this:
\begin{equation}\label{eqn:frame-equiv-2}
  \typequiv{(\posetiso{\posof{F}}{\posof{G}})}{(\frameequiv{F}{G})}.
\end{equation}
The final result,
\begin{equation}\label{eqn:frame-equiv-3}
  \typequiv{(\posetiso{\posof{F}}{\posof{G}})}{(F \equiv G)},
\end{equation}
is then just a combination of (\ref{eqn:frame-equiv-1}) and (\ref{eqn:frame-equiv-2})

As this result requires a high amount of bureaucracy (such as multiple notions of
isomorphism), the reader might want to look at its completely formal form as constructed
in the \veragda{} formalisation. All of these results that involve frames live in the
\modname{Frame} module. The term witnessing the truth of (\ref{eqn:frame-equiv-1}) is
called \fnname{≃f≃\equiv} whilst the one for (\ref{eqn:frame-equiv-2}) is called
\fnname{≃f≃≅ₚ}. The witness of the main result (\ref{eqn:frame-equiv-3}) is called
\fnname{≅ₚ≃≡}.

The result given in (\ref{eqn:frame-equiv-3}) is remarkable from the perspective of formal
topology. In Chapter~\ref{chap:formal-topo}, we will present a method for generating a
frame from a formal topology, and then prove that it is correct in the sense that the
frame generated following this method satisfies a certain universal property. Indeed, one
can prove that this universal property characterises the generated frame uniquely
\emph{up to isomorphism}. A direct corollary of (\ref{eqn:frame-equiv-3}) is that
\emph{isomorphic frames are equal} so we can now drop the ``up to isomorphism'' and say
that the universal property characterises the generated frame \emph{uniquely}.

\section{Frame of downwards-closed subsets}\label{sec:down-set-frame}

We have shown, in Proposition~\ref{prop:dc-poset}, how to construct the poset of
downwards-closed subsets of a given poset. We will now show that this poset forms a
\emph{frame} with subset intersection as the meet and subset union as the join. The latter
has not been defined yet.

\begin{thm}\label{thm:down-set-frame}
  Given a poset $P$, the poset of downwards-closed subsets of $P$ (i.e.,
  $\dcsubset{\abs{P}}$) (as constructed in Prop.~\ref{prop:dc-poset}), is a frame.
\end{thm}
\begin{proof}
  The top element and the meet operation are just those of the subset inclusion order:
  $\entire{\abs{P}}$ and $\intersectnm{}$ (definitions \ref{defn:entire-subset} and
  \ref{defn:intersection}). The join operation is defined as follows: let $U$ be a family
  of downwards-closed subsets with index set $I$;
  \begin{align*}
    \bigvee_i U_i \quad\is\quad \lambda x.~ \trunc{\sigmaty{i}{I}{\mempow{x}{U_i}}}
      && \text{(using truncation as given in Defn.~\ref{defn:truncation})}.
  \end{align*}
  $\entire{\abs{P}}$ and $\intersectnm{}$ are propositional by construction whereas $\bigvee$
  requires a truncation to be forced to be propositional. Downwards-closure and the
  LUB/GLB properties are easy to verify. For the distributivity law, let $U$ be a
  downwards-closed subset and $\setof{ V_i ~|~ \oftyI{i}{I} }$, a family of
  downward-closed subsets. We must show
  \begin{align*}
    \intersect{U}{\bigvee_i V_i}
      \quad&\equiv\quad \intersect{U}{\left(\lambda x.~ \trunc{\sigmaty{i}{I}{x \epsilon V_i}}\right)}\\
      \quad&=\quad \bigvee_i \left(\intersect{U}{V_i} \right)\\
      \quad&\equiv\quad \lambda x.~ \trunc{\sigmaty{i}{I}{x \in (U \cap V_i)}}.
  \end{align*}
  This follows easily by antisymmetry combined with the induction principle of truncation
  (Defn.~\ref{defn:truncation}), the use of which is made possible by the propositionality
  of both sides of the equality.
\end{proof}

We will denote the frame of downwards-closed subsets of a poset $P$ by $\dcframe{P}$.

\section{Nuclei and their fixed points}\label{sec:nuclei}

To prepare for formal topology, we will now define a technical notion called a
\emph{nucleus}. Simply put, a nucleus on a frame is a meet-preserving monad on the frame
when it is viewed as a category. Nuclei describe quotient frames of a frame, which one
views as subspaces of the space corresponding to that frame. They are presented in
standard treatments of locale theory such as Johnstone~\cite[Sec.~II.2]{stone-spaces}.

As a brief digression, let us note that locales can be viewed as special kinds of toposes,
called \emph{localic} toposes. Nuclei are special cases of what are known as
Lawvere-Tierney topologies~\cite{quantifiers-and-sheaves, nlab-nucleus} in the general
case of a topos.

The reason we are interested in nuclei is that in Chapter~\ref{chap:formal-topo} we will
be focusing on a particular nucleus on the frame of downward-closed subsets: the covering
relation. It is this nucleus that will allow us to describe a topology by letting us
specify ``laws'' that are expected to hold in the resulting frame. This is a form of the
familiar method of \emph{presenting by generators and relations} from algebra. From a
given formal topology, we will \emph{freely} generate a frame and then impose on it the
relation given by this relation of covering.

The development presented in this section corresponds to the \modname{Nucleus} module
in the \veragda{} formalisation.

\begin{defn}[Nucleus]\label{defn:nucleus}
  Let $F : \framenm{}$ be a frame and $j : \abs{F} \rightarrow \abs{F}$ and endofunction on it. We
  say that $j$ is \emph{nuclear} if the following condition holds:
  \begin{alignat*}{4}
    \isnuclearnm{}\quad&:\quad &&(\abs{F} \rightarrow \abs{F}) \rightarrow \hprop{} && &&              \\
    \isnuclear{j} \quad&\is\quad
       &&\pity{x~y}{\abs{F}}{j(\meet{x}{y}) &&~=~ &&\meet{j(x)}{j(y)}}     \\
      &\hspace{0.5em}\times\quad &&\pity{x~~}{\abs{F}}{x &&~\sqsubseteq~ &&j(x)}              \\
      &\hspace{0.5em}\times\quad &&\pity{x~~}{\abs{F}}{j(j(x)) &&~\sqsubseteq~ &&j(x)}        .
  \end{alignat*}
  The propositionality follows by propositions~\ref{prop:sigma-prop} and
  \ref{prop:pi-prop}, and the fact that the carrier set is a set (by the definition of
  $\posetaxnm{}$ from Defn.~\ref{defn:poset}). The type of nuclei is then just the $\sum$
  type collecting all nuclear endofunctions on a frame:
  \begin{equation*}
    \nucleus{} \quad\is\quad \sigmaty{j}{\abs{F} \rightarrow \abs{F}}{\isnuclear{j}}.
  \end{equation*}
  In a context involving a nucleus, we will simply refer to these three nuclearity
  properties as $N_0$, $N_1$, and $N_2$.
\end{defn}

Notice that every nucleus preserves the top element.
\begin{prop}\label{prop:nucleus-resp-top}
  Let $F$ be a frame and $\oftyI{j}{\abs{F} \rightarrow \abs{F}}$ a nucleus on it.
  $j(\top_F) = \top_F$.
\end{prop}
\begin{proof}
  Clearly, $j(\top_F) \sqsubseteq \top_F$ and $\top_F \sqsubseteq j(\top_F)$ by $N_1$. We are done by antisymmetry.
\end{proof}

Notice also that every nucleus is monotonic (given in Prop.~\ref{prop:nucleus-mono}).

\begin{lemma}\label{lem:meet-eq}
  $x \sqsubseteq y$ if and only if $x = x \wedge y$ in any frame.
\end{lemma}
\begin{proof}
  Let $F$ be a frame and let $\oftyII{x}{y}{\abs{F}}$. Suppose that $x \sqsubseteq y$. We have $x \wedge
  y \sqsubseteq x$ so it suffices by antisymmetry to show $x \sqsubseteq x \wedge y$. This holds as well since $x \wedge
  y$ is greater than any other lower bound and $x$ is a lower bound of $x$ and $y$: $x \sqsubseteq
  x$ and $x \sqsubseteq y$. For the other direction, suppose that $x = x \wedge y$. We have $x \sqsubseteq x \wedge y \sqsubseteq
  y$.
\end{proof}

\begin{prop}\label{prop:nucleus-mono}
  Every nucleus is monotonic.
\end{prop}
\begin{proof}
  Let $F$ be a frame and $j : \abs{F} \rightarrow \abs{F}$, a nucleus on it. Let
  $\oftyII{x}{y}{\abs{F}}$ and suppose $x \sqsubseteq y$. It can be observed that $j(x) \sqsubseteq j(y)$ is
  the case as follows:
  \begin{align*}
    j(x) &\quad=\quad j(\meet{x}{y})        && [\text{Lemma~\ref{lem:meet-eq}}]               \\
         &\quad=\quad \meet{j(x)}{j(y)}     && [N_0]                                          \\
         &\quad\sqsubseteq\quad {j(y)}                && [\text{$\meet{j(x)}{j(x)}$ is a lower bound}]  .
  \end{align*}
\end{proof}

Given a nucleus $\oftyI{j}{\abs{F} \rightarrow \abs{F}}$ on a frame $F$, we will be interested in
those inhabitants of $\abs{F}$ that are $j$-closed, that is, fixed points of $j$. Starting
with a frame $F$, its subset consisting of $j$-closed elements (for some nucleus $j$) is
itself a frame.

Let us start working towards a proof of this by constructing the underlying poset of this
frame.
\begin{prop}\label{prop:fixed-point-poset}
  Given a frame $F$ and a nucleus $\oftyI{j}{\abs{F} \rightarrow \abs{F}}$, the type
  \begin{equation*}
    \sigmaty{x}{\abs{F}}{j(x) = x}
  \end{equation*}
   of $j$-closed elements forms a poset under the ordering $\sqsubseteq_F$.
\end{prop}
\begin{proof}[Proof sketch]
  The proof amounts to forgetting the information of being a fixed point. For
  antisymmetry, we use Proposition~\ref{prop:to-subtype} along with the fact that the
  carrier set is an h-set (by the definition of $\posetaxnm{}$ from
  Defn.~\ref{defn:poset}).

  Notice that $\abs{F}$ is an h-set by the definition of a poset meaning $j(x) = x$ is a
  proposition for every $\oftyI{x}{\abs{F}}$. Since every proposition is a set
  (Prop.~\ref{prop:prop-is-set}), it follows that $\sigmaty{x}{\abs{F}}{j(x) = x}$ is a
  set by Prop.~\ref{prop:sigma-prop}.
\end{proof}

The \veragda{} construction corresponding to Prop.~\ref{prop:fixed-point-poset} can be
found in the \modname{Nucleus} module under the name \fnname{𝔣𝔦𝔵-pos}.

Now, we are ready to prove the main theorem of this section: this poset of $j$-closed
elements of a frame is itself a frame. The proof we present is an adaptation of
Johnstone's proof \cite[II.2.2, pg.~49]{stone-spaces} to the type-theoretical setting. The
corresponding \veragda{} proof can be found in the \modname{Nucleus} module under the name
\fnname{𝔣𝔦𝔵}.

\begin{thm}\label{thm:fixed-point-frame}
  The set of fixed points for a nucleus $j$ on some frame $F$ forms a frame, with the meet
  operator ($\_\wedge\_$) and the top element ($\top$) taken directly from $F$, and the join
  defined as:
  \begin{equation*}
    \bigvee_i x_i \quad\is\quad j \left( \bigvee^F_i x_i \right).
  \end{equation*}
\end{thm}
\begin{proof}
  We start by showing that the meets and the top element respect the fixed point property.
  $\top$ is a fixed point by Prop.~\ref{prop:nucleus-resp-top}. For the meet operation, let
  $\oftyII{x}{y}{\abs{F}}$ such that $j(x) = x$ and $j(y) = y$. We have:
  \begin{align*}
    j(x \wedge y) &= j(x) \wedge j(y) && [N_0] \\
             &= x \wedge y       && [j(x) = x~\text{and}~j(y) = y].
  \end{align*}

  We now show that the join operator, defined by applying $j$ on the join of $F$, actually
  yields a LUB. Let $\setof{ x_i ~|~ i \in I }$ be a family of $j$-closed elements and let
  $\oftyI{i}{I}$. We have
  \begin{equation*}
    x_i \sqsubseteq \bigvee^F_k x_k \sqsubseteq j\left( \bigvee^F_k x_k \right)
  \end{equation*}
  by $N_1$ meaning it is an upper bound. To see that it is the least such, let $u$ be some
  other upper bound of $\{ x_i ~|~ i \in I \}$ such that $j(u) = u$. We need to show that $j
  \left( \bigvee^F_k x_k \right) \sqsubseteq u$. Since $u = j(u)$ it suffices by the monotonicity of $j$
  (Prop.~\ref{prop:nucleus-mono}) to show $\bigvee^F_i x_i \sqsubseteq u$. We are done since $u$ is an
  upper bound of $\{ x_i ~|~ i \in I \}$.

  It remains to be shown that the infinite distributivity law is satisfied. Let
  $\oftyI{x}{\abs{F}}$ such that $j(x) = x$ and let $\{ y_i ~|~ i \in I \}$ be a family.
  By Prop.~\ref{prop:to-subtype}, the proofs fixed-point-ness are irrelevant as the
  carrier is an h-set. The result then follows as:
  \begin{align*}
    x \wedge \bigvee_i y_i
      &\quad\equiv\quad x    \wedge j\left( \bigvee^F_i y_i \right)      && [x = j(x)]                     \\
      &\quad=\quad j(x) \wedge j\left( \bigvee^F_i y_i \right)      && [N_0]                          \\
      &\quad=\quad j \left( x \wedge \bigvee^F_i y_i \right)        && [\text{distributivity of}\ F]  \\
      &\quad=\quad j \left( \bigvee^F_i x \wedge y_i \right)                                          \\
      &\quad\equiv\quad \bigvee_i x \wedge y_i                                                             .
  \end{align*}
\end{proof}

Given a frame $F$, and a nucleus $j$ on it, we will refer to the frame of $j$-closed
elements as $\fix{F}{j}$.

\begin{agdanotation}
  The corresponding function in the \veragda{} formalisation is called
  $\fnname{𝔣𝔦𝔵}$.
\end{agdanotation}

In Chapter~\ref{chap:formal-topo}, we will make use of nuclei to present a frame from a
certain nucleus on the frame of downwards-closed subsets of a poset.
