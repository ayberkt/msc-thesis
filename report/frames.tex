\chapter{Frames}\label{chap:frames}

We present in this chapter the lattice-theoretic notion of a \emph{frame}. In
Chapter~\ref{chap:intro}, we remarked that a frame is the algebra of a logic of finitely
verifiable properties. Recall that a frame consists of the following:
\begin{itemize}
  \item a set $O$ of \emph{opens},
  \item a partial order $\_\sqsubseteq\_ \subseteq O \times O$, corresponding to the set inclusion order of the
    open subsets,
  \item finite meets, and
  \item arbitrary joins.
\end{itemize}

In addition to these, there is a law that is needed to ensure the correct interplay
between meets and joins. Suppose that we have a set $A$ and a family of sets $B_0, B_1,
\cdots$. Consider the set:
\begin{equation*}
  A \cap (\bigcup_i B_i).
\end{equation*}
By set-theoretic reasoning, this is the same as:
\begin{equation*}
  \bigcup_i (A \cap B_i).
\end{equation*}
As we are trying to characterise the behaviour of open sets, without defining them as sets
of points, we have to explicitly add this distributivity law into the definition of a
frame. Put simply:
\begin{center}
  \emph{binary meets must distribute over arbitrary joins in a frame.}
\end{center}

We now start presenting our formal development of frames. We start with partially ordered
sets in Section~\ref{sec:poset}, which underlie frames. In Section~\ref{sec:frame}, we
present the definition of a frame. In Section~\ref{sec:frame-univ}, we present a theorem
unique to univalent foundations: isomorphic frames are equal. In sections
\ref{sec:down-set-frame} and \ref{sec:nuclei}, we prove two important theorems in
preparation for the chapter on formal topology (Chapter~\ref{chap:formal-topo}): (1) the
set of downwards-closed subsets of a poset forms a frame and (2) given a nucleus (a
technical notion to be introduced) on a frame, its set of fixed points is itself a frame.

\section{Partially ordered sets}\label{sec:poset}

This section corresponds to the \modname{Poset} module in the \veragda{} development.

\begin{defn}[Poset]\label{defn:poset}
  Given some $\oftyI{A}{\univ{}_m}$, let $\order{n}{A} \is A \rightarrow A \rightarrow \hprop{}_n$. A poset at
  carrier level $m$ and relation level $n$ is then defined as:
  \begin{equation*}
    \poset{}_{m, n} \quad\is\quad \sigmaty{A}{\univ_m}{\posetstr{n}{A}},
  \end{equation*}
  \begin{center}
  where
  \end{center}
  \begin{align*}
    \posetstr{n}{A} \quad&\is\quad \sigmaty{R}{\order{n}{A}}{\posetax{A, R}}              \\
    \posetaxnm \quad&:\quad \pity{A}{\univ{}_m}{\order{n}{A} \rightarrow \hprop{}_{\max(m, n)}}           \\
    \posetax{A, R} \quad&\is\quad ~~\pity{x}{A}{R(x, x)}                      \\
                    &\hspace{0.3em}\times \pity{x~y~z}{A}{R(x, y) \rightarrow R(y, z) \rightarrow R(x, z)} \\
                    &\hspace{0.3em}\times \hspace{0.3em}\pity{x~y}{A}{R(x, y) \rightarrow R(y, x) \rightarrow x =_A y}   \\
                    &\hspace{0.3em}\times \isset{A}
  \end{align*}
  Propositionality of $\posetaxnm{}$ follows by propositions \ref{prop:sigma-prop},
  \ref{prop:pi-prop}, and \ref{prop:set-prop}.
\end{defn}

Given a poset $P$, we will refer to its relation as $\_\sqsubseteq_P\_$ (in cases where there might
be ambiguity) and the underlying set of $P$ as $\abs{P}$. Notice that the fourth component
of $\posetaxnm{}$ requires the carrier set to be an h-set (Defn.~\ref{defn:hset}).

Given a poset $P$, we will talk about its \emph{downwards-closed subsets}: sets that
include all elements below their elements. One way of reading this notion is: verification
at a certain stage of information. Take a certain element $x : \abs{P}$ that we view as a
stage of information. For some other $\oftyI{y}{\abs{P}}$, $y \sqsubseteq x$ expresses the idea that
$y$ is a \emph{finer} stage of information i.e., it contains more information hence
admitting \emph{less}. Let $U$ be a subset of $\abs{P}$. The property that $U$ is
downward-closed is then nothing but:
\begin{equation*}
  x \in U \rightarrow y \sqsubseteq x \rightarrow y \in U,
\end{equation*}
the intuitive reading of which is: $U$ contains all stages that are ramifications of the
stages it contains. This is another way of saying that $U$ is an \emph{observable}
property: when we find an element $x$ contained in $U$, all possible refinements of $x$
are guaranteed to stay in $U$. In other words, the reception of more information does not
disrupt the property $U$.

Let us formally summarise the notion of downwards-closure.
\begin{defn}[Downwards-closed subset]\label{defn:dc-subset}
  We first define a predicate expressing that a given subset of $P$ is downwards-closed:
  \begin{alignat*}{2}
    \isdcnm{}   &\quad:\quad     &&\poset{} \rightarrow \pow{\abs{P}} \rightarrow \hprop{}    \\
    \isdc{P, U} &\quad\is{}\quad &&\pity{x~y}{\abs{P}}{x \in U \rightarrow y \sqsubseteq x \rightarrow y \in U}   .
  \end{alignat*}
  The propositionality follows by Proposition~\ref{prop:pi-prop}. We then define the type
  of downwards-closed subsets of a poset as:
  \begin{alignat*}{2}
    \dcsubsetnm{} &\quad:\quad     &&\poset{} \rightarrow \univ{}                      \\
    \dcsubset{P}  &\quad\is{}\quad &&\sigmaty{U}{\pow{\abs{P}}}{\isdc{P, U}} .
  \end{alignat*}
\end{defn}

So far we have dealt with two notions of \emph{observable property} throughout the
development:
\begin{enumerate}
  \item elements of a poset which we will view as opens when we get to frames, and
  \item the notion of downwards-closed subset which expresses that a property of the poset
    of opens behaves like an observable property.
\end{enumerate}
We will now start relating these two by showing that the set of downwards-closed subsets
of a poset is itself a poset, and indeed, we will prove later (in
Sec.~\ref{sec:down-set-frame}) that it actually forms a frame meaning downwards-closed
subsets satisfy our expectations from properties we view as observable.

Let us start by showing that $\dcsubset{P}$ is always a set.
\begin{prop}\label{isSetDCSubset}
  $\dcsubset{P}$ is a set for every poset $P$.
\end{prop}
\begin{proof}
  By Proposition~\ref{prop:sigma-set}, it suffices to show that $\pow{\abs{P}}$ is a set
  and $$\isdc{P, U}$$ is a set for every $\oftyI{U}{\pow{\abs{P}}}$. The former holds by
  Proposition~\ref{prop:pow-set}. For the latter, observe that every $\isdc{P, U}$ is a
  proposition by definition meaning it is also set by Proposition~\ref{prop:prop-is-set}.
\end{proof}

We can now proceed to construct the poset of downwards-closed subsets.
\begin{prop}(Poset of downwards-closed subsets)\label{prop:dc-poset}
  Let $P$ be a poset. The type $\dcsubset{P}$ forms a poset under the
  inclusion relation.
\end{prop}
\begin{proof}
  The fact that $\dcsubset{P}$ is a set is given by Proposition~\ref{isSetDCSubset} so it
  suffices to show that the poset axioms are satisfied. Reflexivity and transitivity are
  immediate. For antisymmetry, let $\oftyII{(U, \_)}{(V, \_)}{\dcsubset{P}}$ and assume
  $\subsetof{U}{V}$, $\subsetof{V}{U}$. By Proposition~\ref{prop:to-subtype}, it suffices
  to show $U = V$ as downwards-closure is a proposition. By function extensionality
  (Prop.~\ref{prop:funext}), it suffices to show, for every $x : \abs{P}$, $U(x) = V(x)$.
  Since $\oftyII{U(x)}{V(x)}{\hprop{}}$, it is sufficient to show $\logequiv{U(x)}{V(x)}$
  which we know to hold by assumption.
\end{proof}

Observe that we made use of function extensionality in the antisymmetry proof. As function
extensionality depends on the univalence axiom, this means that we would not have been
able to complete the antisymmetry proof without univalence.

\subsection{Monotonic functions}

Let us now write down the type of those functions that preserve the partial order
structure of a poset: monotonic maps.

\begin{defn}[Monotonic function]\label{defn:mono-map}
  Let $P, Q$ be posets. A function $f : \abs{P} \rightarrow \abs{Q}$ is monotonic if the following
  type is inhabited:
  \begin{equation*}
    \ismonotonic{f} \quad\is\quad \pity{x~y}{\abs{P}}{x \sqsubseteq_P y \rightarrow f(x) \sqsubseteq_Q f(y)}.
  \end{equation*}
  We collect the type of monotonic functions between posets $P$ and $Q$ in the following
  type:
  \begin{equation*}
    \mono{P}{Q} \quad\is\quad \sigmaty{f}{\abs{P} \rightarrow \abs{Q}}{\ismonotonic{f}}
  \end{equation*}
\end{defn}

\begin{defn}[Poset isomorphism]\label{defn:poset-iso}
  An isomorphism between two posets is a monotonic function with a monotonic inverse.
\end{defn}

\section{Definition of a frame}\label{sec:frame}

We now proceed to define frames as discussed. The constructions presented here can be
found in the \modname{Frame} module in the \veragda{} formalisation.

\begin{defn}[Frame]\label{defn:frame}
  A frame structure on some type $A$ consists of the following data: (1) a poset
  structure, (2) a top element, (3) a binary meet operation, and (4) a join operation of
  arbitrary arity, which we define using families. We call this the \emph{raw} frame
  structure:
  \begin{equation*}
    \rawframestr{n}{o}{A} \quad\is\quad \posetstr{n}{A} \times A \times (A \rightarrow A \rightarrow A) \times (\sub{o}{A} \rightarrow A).
  \end{equation*}
  This raw structure must be subject to the following axioms.
  \begin{alignat*}{2}
    \frameax{\sqsubseteq, \top, \wedge, \bigvee} \quad&\is\quad             &&\mathsf{isTop}(\top) \times
                                              \mathsf{isGLB}(\wedge) \times
                                              \mathsf{isLUB}\left( \bigvee \right)\\
                          &\hspace{0.55em}\times &&\mathsf{isDistr}\left( \wedge, \bigvee \right)
  \end{alignat*}
  where
  \begin{alignat*}{2}
    \mathsf{isTop}(\top) \quad&\is\quad &&\pity{x}{A}{x \sqsubseteq \top}\\
    \mathsf{isGLB}(\wedge) \quad&\is\quad &&\pity{x~y}{A}{(x \wedge y \sqsubseteq x) \times (x \wedge y \sqsubseteq y)}\\
                       &\hspace{0.55em}\times &&\pity{z~~}{A}{(z \sqsubseteq x) \times (z \sqsubseteq y) \rightarrow z \sqsubseteq x \wedge y}\\
    \mathsf{isLUB}\left(\bigvee\right) \quad&\is\quad
         &&\pity{U}{\sub{o}{A}}{\pity{x}{A}{\memfam{x}{U} \rightarrow x \sqsubseteq \bigvee_i U_i}}\\
         &\hspace{0.55em}\times &&\pity{U}{\sub{o}{A}}{\pity{x}{A}{
        \left( \pity{y}{A}{\memfam{y}{U} \rightarrow y \sqsubseteq x}\right) \rightarrow \bigvee_i U_i \sqsubseteq x }}\\
    \mathsf{isDistr}(\wedge, \bigvee) \quad&\is\quad
      &&\pity{x}{A}{\pity{U}{\sub{o}{A}}{
          x \wedge \bigvee_i U_i} =_A \bigvee_i \left( x \wedge U_i \right)
      }
  \end{alignat*}
  We collect frames in the following type:
  \begin{equation*}
    \framety{m}{n}{o} \quad\is\quad
      \sigmaty{A}{\univ{}_m}{
        \sigmaty{S}{\rawframestr{n}{o}{A}}{\frameax{S}}
      }.
  \end{equation*}
\end{defn}

We will use the notation $\abs{F}$ for referring to the underlying set of a frame, as we
do for posets. Similarly, we will refer to the underlying partial order as $\_\sqsubseteq_F\_$, the
join operator as $\bigvee^F$, and the meet operator as $\wedge_F$. we will refer colloquially to its
underlying poset. We will formally notate this as $\posof{F}$ if the need arises.

\begin{prop}\label{prop:frame-ax-prop}
  For every raw frame structure $(\sqsubseteq, \top, \wedge, \bigvee)$, $\frameax{\sqsubseteq, \top, \wedge, \bigvee}$ is a proposition.
\end{prop}
\begin{proof}[Proof sketch]
  By Proposition~\ref{prop:sigma-prop}, it suffices to show that each component is an
  h-prop. For $\mathsf{isTop}$, $\mathsf{isGLB}$, and $\mathsf{isLUB}$ this can be
  concluded by using Proposition~\ref{prop:sigma-prop} and Proposition~\ref{prop:pi-prop}.
  For $\mathsf{isDistr}$, we use Proposition~\ref{prop:pi-prop} followed by the fact that
  the underlying set of a poset is an h-set (by the definition of $\posetaxnm{}$ from
  Definition~\ref{defn:poset}).
\end{proof}

\subsection{Frame homomorphisms}

As we have just introduced a new structure, we shall define what it means for a function
to preserve this structure.

\begin{defn}[Frame homomorphism]\label{defn:frame-homo}
  Let $F$ and $G$ be frames with the same index level. A frame homomorphism from $F$ to
  $G$ is a monotonic map (Defn.~\ref{defn:mono}) from the underlying poset of $F$ to the
  underlying poset of $G$ that preserves the top element, the meets, and the joins.
  Formally,
  \begin{alignat*}{5}
    \isframehomo{f} \quad&\is\quad && &&f(\top_F) &&\idnm{} &&\top_G \\
      &\hspace{0.55em}\times\quad  &&\pity{x~y}{\abs{F}}{&&f(x \wedge_F y) &&\idnm{} &&f(x) \wedge_G f(y)} \\
      &\hspace{0.55em}\times\quad  &&\pity{U}{\sub{o}{\abs{F}}}{&&f(\bigvee^F U) &&\idnm{} &&\bigvee^G \setof{ f(x) ~|~ x \in U }}.
  \end{alignat*}
  Observe that this is propositional by propositions \ref{prop:sigma-prop},
  \ref{prop:pi-prop}, and the fact that the carrier of $G$ is an h-set. The type of frame
  homomorphisms between $F$ and $G$ is then just:
  \begin{equation*}
    \framehomo{F}{G} \quad\is\quad \sigmaty{f}{\mono{\posof{F}}{\posof{G}}}{\isframehomo{f}}.
  \end{equation*}
\end{defn}

\section{Some properties of frames}

\begin{prop}[Meet commutativity]\label{prop:comm}
  In any frame $F$, $x \wedge_F y = y \wedge_F x$ for all $\oftyII{x}{y}{\abs{F}}$.
\end{prop}
The proof is trivial and therefore omitted.

\begin{lemma}[Flattening lemma]\label{lem:flatten}
  Let $\oftyI{F}{\framety{m}{n}{o}}$ and let $\oftyI{f}{\pity{a}{A}{B(a) \rightarrow \abs{F}}}$ for
  some $\oftyI{A}{\univ{}_o}$ and $\oftyI{B}{A \rightarrow \univ{}_o}$. The following equality
  holds:
  \begin{equation*}
      \bigvee^F \setof{ \bigvee^F \setof{ f(a, b) ~|~ b \in B(a) } ~|~ \oftyI{a}{A}          }
    = \bigvee^F \setof{ f(a, b)             ~|~ \oftyI{(a, b)}{\sigmaty{x}{A}{B(x)}} }.
  \end{equation*}
\end{lemma}

We omit the proof of Lemma~\ref{lem:flatten} as its content is not particularly
interesting and involves a non-trivial amount of bureaucracy. It can be found in the
\veragda{} formalisation, in the \modname{Frame} module; the constructed inhabitant is
named \fnname{flatten}.

The distributivity law we required in the definition of a frame is asymmetric: the join
has to be the right operand of the meet for it to apply. Of course, this does not matter
thanks to Proposition~\ref{prop:comm} but it is certainly inconvenient to work with. We
now provide a symmetrised form of distributivity.

\begin{prop}\label{prop:distr}
  Let $\oftyI{F}{\framety{m}{n}{o}}$ and $\oftyII{U}{V}{\sub{o}{\abs{F}}}$. Call the index
  types of $U$ and $V$, $I$ and $J$, respectively. The following equality holds:
  \begin{equation*}
      \left( \bigvee_i U_i \right) \wedge \left( \bigvee_i V_i \right)
    = \bigvee \setof{ U_i \wedge V_j ~|~ \oftyI{(i, j)}{I \times J} }.
  \end{equation*}
\end{prop}
\begin{proof}[Proof sketch]
  Apply the distributivity law, use commutativity (Prop.~\ref{prop:comm}), apply the
  distributivity law again, and then flatten (using Lemma~\ref{lem:flatten}).
\end{proof}

\section{Isomorphic frames are equal}\label{sec:frame-univ}

It is common practice in mathematics to regard two isomorphic structures as equal.
However, this requires mathematicians to view isomorphism as the appropriate notion of
equality on structures, as neither set-theoretical nor (non-univalent) type-theoretical
foundations support this informal practice. One of the remarkable features of univalent
type theory is that it solves this problem: in a univalent setting, we can actually prove
that two isomorphic structures are equal.

As frames are the central objects of study of this thesis, we will prove that isomorphic
frames are equal. For this, we will make use of a \emph{structure identity principle} (SIP
for short): a description of the identity type between two structures in terms of
equivalences of the carrier types (as explained by Escardó~\cite{escardo-uf-intro}). The
first SIP was formulated by Coquand and Danielsson~\cite{coq-nad} and another one is given
in the HoTT Book~\cite{hottbook}.

We use the SIP due to Martín Escardó~\cite{escardo-uf-intro}, as implemented in the
\texttt{cubical} library~\cite{agda-cubical} of \veragda{}. Instead of going into the
details of our proofs, we will provide a high-level overview of what this SIP requires and
what exactly we have proven in the \veragda{} formalisation to be able to use it.

We have specified the \emph{structure} of a poset and a frame (in definitions
\ref{defn:poset} and \ref{defn:frame}) in two steps: (1) writing down a function with type
$\univ{}_m \rightarrow \univ{}_n$, expressing what it means for a type to have a certain structure,
and (2) defining what it means for a function on the underlying types to preserve this
structure, hence describing the isomorphisms of such structures.

Now, we would like to speak generally about mathematical structures, specified by (1) and
(2). This requires us to describe the conditions under which a notion of isomorphism of
structures is well-behaved. Such a collection of conditions is called a
\emph{standard notion of structure} by Escard\'{o}~\cite{escardo-uf-intro}.

When is an isomorphism well-behaved? Let $\oftyI{S}{\univ{}_m \rightarrow \univ{}_n}$ be a structure,
and let $\iota$ be a function expressing that a given equivalence between the underlying
types of two structures (i.e., inhabitants of type $\sigmaty{X}{\univ{}_m}{S(X)}$)
respects the $S$-structure. The type of $\iota$ looks like the following:
\begin{equation*}
  \oftyI{\iota}{%
    \pity{(A , \_)~(B , \_)}{\sigmaty{X}{\univ{}_m}{S(X)}}{%
      \typequiv{A}{B} \rightarrow \univ{}_o
    }
  }.
\end{equation*}

In the case of ordered structures, for instance, we would pick $S \is \ordernm{}_k$ which
has type:
\begin{equation*}
  \oftyI{\ordernm{}_k}{\univ{}_m \rightarrow \univ{}_{\max(m, k+1)}},
\end{equation*}
and $\iota$ would be defined as
\begin{equation*}
  \iota((A, \sqsubseteq_A), (B, \sqsubseteq_B), (f , \_)) \quad\is\quad \logequiv{x \sqsubseteq_A y}{f(x) \sqsubseteq_B f(y)}.
\end{equation*}
This delineates those equivalences that have the virtue of preserving the $S$-structure on
the types $A$ and $B$. In our particular case, we said that a poset isomorphism is a
monotonic function with a monotonic inverse, which would be equivalent to $\iota$.

We require $\iota$ to satisfy two conditions to make sure it is a well-behaved
characterisation of homomorphic equivalences.
\begin{enumerate}
  \item The identity equivalence meets the $\iota$ criterion: for every $\oftyI{(A,
    s)}{\sigmaty{X}{\univ{}}{S(X)}}$, $\iota((A, s), (A, s), \idequiv{A})$ is inhabited.
  \item Given some $\iota$ satisfying (1), and given a type $A$ with two structures
    $\oftyII{s}{t}{S(A)}$, there is a map:
    \begin{equation*}
      s = t \rightarrow \iota((A, s), (A, t), \idequiv{A}).
    \end{equation*}
    The second requirement is that this map is an equivalence.
\end{enumerate}

Let $A, B$ be two types with $S$-structures $s$ and $t$. The SIP then gives us that, if
$S$ is standard in the sense that it satisfies (1) and (2), the type of $\iota$-equivalences
between $(A, s)$ and $(B, t)$ is equivalent to the identity type between them.

When presenting both frames and posets, we have separated our structures into two: the
data (e.g., the operations, the relation) and the axioms that constrain how these behave,
which we made sure are propositional as we expected them to be properties of the data. The
motivation for this, besides the organisational neatness, is that we can take a raw SNS
and combine this with some axioms on the raw structure without disrupting the SNS
property. Both Escard\'{o}'s implementation~\cite{escardo-uf-intro} and the implementation
from the \texttt{cubical} library~\cite{agda-cubical} provide mechanisms for building
mathematical structures this way and we have made use of this in the \veragda{}
formalisation.

To conclude this section, let us state formally, the exact theorems we have obtained using
the SIP.

\begin{thm}[Isomorphic posets are equal]
  Let $P$ and $Q$ be two posets. If $P$ is isomorphic to $Q$
  (by Defn.~\ref{defn:poset-iso}) then $P = Q$. Formally,
  \begin{equation*}
    \pity{P~Q}{\poset{}_{m, n}}{%
      \left(
        \sigmaty{f}{\mono{P}{Q}}{\sigmaty{g}{\mono{Q}{P}}{%
            \exteq{(f \circ g)}{\mathsf{id}} \times \exteq{(g \circ f)}{\mathsf{id}}
          }
        }
      \right)
      \rightarrow P = Q
    }
  \end{equation*}
  where $\mathsf{id} \is \lambda x.~x$.
\end{thm}

\begin{thm}[Isomorphic frames are equal]\label{thm:frame-univ}
  \todo{state.}
\end{thm}

This result is remarkable from the perspective of formal topology. In
Chapter~\ref{chap:formal-topo}, we will present a method for generating a frame from a
formal topology and prove that this satisfies the universal property of the freely
generated frame. Indeed, one can prove that this universal property characterises the free
frame uniquely \emph{up to isomorphism}. As we have just shown in
Theorem~\ref{thm:frame-univ}, isomorphism of frames \emph{is} equality of frames, so we
can now drop the ``up to isomorphism'' and say that the universal property characterises
the free frame \textbf{uniquely}.

\section{Frame of downwards-closed subsets}\label{sec:down-set-frame}

We have shown, in Proposition~\ref{prop:dc-poset}, how to construct the poset of
downwards-closed subsets of a given poset. We will now show that this poset forms a
\emph{frame} with subset intersection and subset union.

\begin{thm}\label{thm:down-set-frame}
  Given a poset $P$, the poset of downwards-closed subsets of $P$ (as constructed in
  Theorem~\ref{prop:dc-poset}), is a frame.
\end{thm}
\begin{proof}
  The top element and the meet operation are just those of the subset-inclusion order
  (definitions \ref{defn:entire-subset} and \ref{defn:intersection}). The join operation
  is defined as follows: let $U$ be a family of downwards-closed subsets with index set
  $I$;
  \begin{align*}
    \bigvee_i U_i \quad\is\quad \lambda x.~ \trunc{\sigmaty{i}{I}{x \in U_i}}
      && \text{(using truncation as given in Defn.~\ref{defn:truncation})}.
  \end{align*}
  $\top$ and $\cap$ are propositional by construction whereas $\bigvee$ requires a truncation to be
  forced to be propositional. Downwards-closure and the LUB/GLB properties are easy to
  verify. For the distributivity law, let $U$ be a downwards-closed subset and $V$, a
  family (with index set $I$) of downward-closed subsets. We must show
  \begin{align*}
    \intersect{U}{\bigvee_i V_i}
      \quad&\equiv\quad \intersect{U}{\left(\lambda x.~ \trunc{\sigmaty{i}{I}{x \epsilon V_i}}\right)}\\
      \quad&=\quad \bigvee_i \left(\intersect{U}{V_i} \right)\\
      \quad&\equiv\quad \lambda x.~ \trunc{\sigmaty{i}{I}{x \in (U \cap V_i)}}.
  \end{align*}
  This follows easily using the induction principle of truncation
  (Defn.~\ref{defn:truncation}), the incantation of which is made possible by the
  propositionality of both sides of the equality. We will denote the frame of
  downwards-closed subsets of a poset $P$ as $\dcframe{P}$.
\end{proof}

\section{Nuclei and their fixed points}\label{sec:nuclei}

To prepare for formal topology, we will now define a technical notion called a
\emph{nucleus}. Nuclei describe quotient frames of a frame, which one views as subspaces
of the space corresponding to that frame. They are presented by Johnstone
in~\cite[Sec.~II.2]{stone-spaces}. In the general case of a topos, nuclei correspond to
Lawvere-Tierney topologies~\cite{nlab-nucleus}.

The reason we are interested in nuclei is that in Chapter~\ref{chap:formal-topo} we will
be focusing on a particular nucleus on the frame of downward-closed subsets: the covering
relation. It is this nucleus that will allow us to describe a topology by letting us
specify laws that are expected to hold in the resulting frame.

The development presented in this section corresponds to the \modname{Nucleus} module
in the \veragda{} formalisation.

\begin{defn}[Nucleus]\label{defn:nucleus}
  Let $F : \mathsf{Frame}_{m, n, o}$ and $j : \abs{F} \rightarrow \abs{F}$ and endofunction on it.
  We say that $j$ is \emph{nuclear} if the following condition holds:
  \begin{alignat*}{4}
    \isnuclearnm{}\quad&:\quad &&(\abs{F} \rightarrow \abs{F}) \rightarrow \Omega && &&              \\
    \isnuclear{j} \quad&\is\quad
       &&\pity{x~y}{\abs{F}}{j(\meet{x}{y}) &&~=~ &&\meet{j(x)}{j(y)}}  \\
      &\hspace{0.4em}\times\quad &&\pity{x~~}{\abs{F}}{x &&~\sqsubseteq~ &&j(x)}           \\
      &\hspace{0.4em}\times\quad &&\pity{x~~}{\abs{F}}{j(j(x)) &&~\sqsubseteq~ &&j(x)}.
  \end{alignat*}
  The propositionality follows by propositions~\ref{prop:sigma-prop} and
  \ref{prop:pi-prop}, and the fact that the carrier set is a set (by the definition of
  $\posetaxnm{}$ from Defn.~\ref{defn:poset}).

  The type of nuclei is then just the $\sum$ type collecting all nuclear endofunctions on a
  frame:
  \begin{equation*}
    \nucleus{} \quad\is\quad \sigmaty{j}{\abs{F} \rightarrow \abs{F}}{\isnuclear{j}}.
  \end{equation*}
\end{defn}

A notational clarification before we proceed: in a context involving a nucleus, we will
simply refer to these three nuclearity properties as $N_0$, $N_1$, and $N_2$.

Notice that every nucleus is monotonic.
\begin{prop}\label{prop:nucleus-mono}
  Every nucleus is monotonic.
\end{prop}
\begin{proof}
  Let $F$ be a frame and $j : \abs{F} \rightarrow \abs{F}$ a nucleus on it. Let
  $\oftyII{x}{y}{\abs{F}}$ and suppose $x \sqsubseteq y$. We need to show that $j(x) \sqsubseteq j(y)$. First,
  notice that $x = \meet{x}{y}$ by antisymmetry since $\meet{x}{y} \sqsubseteq x$ and $x \sqsubseteq
  \meet{x}{y}$ as $\meet{x}{y}$ is greater than any other lower bound and $x$ is a lower
  bound as it is less than both itself and $y$.
  \begin{align*}
    j(x) &\quad=\quad j(\meet{x}{y})                 && [x = \meet{x}{y}]                      \\
         &\quad=\quad \meet{j(x)}{j(y)}              && [N_0]                                  \\
         &\quad\sqsubseteq\quad {j(y)}                         && [\text{$\meet{}{}$ is a lower bound}]  .
  \end{align*}
\end{proof}

Given a nucleus $\oftyI{j}{\abs{F} \rightarrow \abs{F}}$ on a frame $F$, we will be interested in
those inhabitants of $\abs{F}$ that are $j$-closed i.e., that are fixed points of $j$.
Starting with a frame $F$, its subset consisting of $j$-closed elements (for some nucleus
$j$) is itself a frame, being the quotient frame described by $j$.

To prove this fact, let us first construct the underlying poset of this frame.
\begin{prop}
  Given a frame $F$ and a nucleus $\oftyI{j}{\abs{F} \rightarrow \abs{F}}$, the type
  \[\sigmaty{x}{\abs{F}}{j(x) = x}\] of $j$-closed elements forms a poset.
\end{prop}
\begin{proof}[Proof sketch]
  The proof amounts to forgetting the information of being a fixed point. For
  antisymmetry, we use Proposition~\ref{prop:to-subtype} along with the fact that the
  carrier set is an h-set (by the definition of $\posetaxnm{}$ from
  Defn.~\ref{defn:poset}).
\end{proof}

Now, we are ready to prove the main theorem of this section: this poset of $j$-closed
elements of a frame is itself a frame. The proof we present has been adapted to the
type-theoretic setting from Johnstone's proof in \cite[II.2.2, pg.~49]{stone-spaces}. The
corresponding \veragda{} proof can be found in the \modname{Frame} module by the name
\fnname{DCFrame}.

\begin{thm}\label{thm:fixed-point-frame}
  The set of fixed points for a nucleus $j$ on some frame $F$ forms a frame.
\end{thm}
\begin{proof}
  The binary meets and the top element are taken directly from the frame $F$. The fact
  that the top element is a fixed point of $j$ is easy to verify: $\top \sqsubseteq j(\top)$ by nuclearity
  (Defn.~\ref{defn:nucleus}). For the meet operation, let $\oftyII{x}{y}{\abs{F}}$ such
  that $j(x) = x$ and $j(y) = y$. $x \wedge y \sqsubseteq j(x \wedge y)$ by $N_1$ so it suffices to show $j(x
  \wedge y) \sqsubseteq x \wedge y$. Nuclei preserve meets so $j(x \wedge y) = j(x) \wedge j(y) \sqsubseteq j(x) = x$ and $j(x \wedge
  y) = j(x) \wedge j(y) \sqsubseteq j(y) = y$. This means that $j(x \wedge y)$ is an upper bound of $x$ and
  $y$ hence $j(x \wedge y) \sqsubseteq x \wedge y$.

  We define the join on a family $\setof{ x_i ~|~ i \in I }$ using $\bigvee^F$ but applying $j$ on
  the result:
  \begin{equation*}
    \bigvee_i x_i \quad\is\quad j \left( \bigvee^F_i x_i \right).
  \end{equation*}
  Notice that this gives a LUB. Let $\{ x_i ~|~ i \in I \}$ be a family of $j$-closed
  elements and let $\oftyI{i}{I}$. We have
  \begin{equation*}
    x_i \sqsubseteq \bigvee^F_j x_j \sqsubseteq j\left( \bigvee^F_j x_j \right)
  \end{equation*}
  by $N_1$ meaning it is an upper bound. To see that it is the least such, let $u$ be some
  other upper bound of $\{ x_i ~|~ i \in I \}$ such that $j(u) = u$. We need to show that $j
  \left( \bigvee^F_k x_k \right) \sqsubseteq u$. Since $u = j(u)$ it suffices by the monotonicity of $j$
  (Prop.~\ref{prop:nucleus-mono}) to show $\bigvee^F_i x_i \sqsubseteq u$. We are done since $u$ is an
  upper bound of $\{ x_i ~|~ i \in I \}$

  It remains to be shown that the infinite distributivity law is satisfied. Let
  $\oftyI{x}{\abs{F}}$ such that $j(x) = x$ and let $\{ y_i ~|~ i \in I \}$ be a family.
  \begin{align*}
    x \wedge \bigvee_i y_i
      &\quad\equiv\quad x    \wedge j\left( \bigvee^F_i y_i \right)      && [x = j(x)]                     \\
      &\quad=\quad j(x) \wedge j\left( \bigvee^F_i y_i \right)      && [N_1]                          \\
      &\quad=\quad j \left( x \wedge \bigvee^F_i y_i \right)        && [\text{distributivity of}\ F]  \\
      &\quad=\quad j \left( \bigvee^F_i x \wedge y_i \right)                                          \\
      &\quad\equiv\quad \bigvee_i x \wedge y_i                                                             .
  \end{align*}

  Given a frame $F$, and a nucleus $j$ on it, we will refer to the frame of $j$-closed
  elements as $\fix{F}{j}$.
\end{proof}

In the next chapter, we will make use of nuclei to a generate the ``freest'' frame (i.e.,
not constrained by any rules except those we have deliberately imposed upon it) from a
formal topology.
